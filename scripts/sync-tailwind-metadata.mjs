import { __unstable__loadDesignSystem } from 'tailwindcss'
import fs from 'node:fs'
import path from 'node:path'
import { fileURLToPath } from 'node:url'
import { createRequire } from 'node:module'

const __dirname = path.dirname(fileURLToPath(import.meta.url))
const require = createRequire(import.meta.url)

const OUTPUT_PATH = path.resolve(
	__dirname,
	'../internal/shared/src/styles/tailwind-data.generated.ts'
)

async function run() {
	console.log('--- Probing Tailwind v4 Design System ---')
	try {
		// Read the base utilities.css from tailwindcss package to avoid resolution errors
		const tailwindPath = path.dirname(
			require.resolve('tailwindcss/package.json')
		)
		const utilitiesCss = fs.readFileSync(
			path.join(tailwindPath, 'utilities.css'),
			'utf8'
		)
		const themeCss = fs.readFileSync(
			path.join(tailwindPath, 'theme.css'),
			'utf8'
		)
		const indexCss = fs.readFileSync(
			path.join(tailwindPath, 'index.css'),
			'utf8'
		)

		// Combine them or just use index.css which has everything
		const designSystem = await __unstable__loadDesignSystem(indexCss, {
			loadStylesheet: async (id) => {
				// Mock stylesheet loader for internal tailwind imports
				const filePath = path.join(
					tailwindPath,
					id.replace(/^tailwindcss\//, '')
				)
				if (fs.existsSync(filePath)) {
					return {
						content: fs.readFileSync(filePath, 'utf8'),
						path: filePath,
						base: tailwindPath,
					}
				}
				return { content: '', path: id, base: tailwindPath }
			},
		})

		const staticKeys = designSystem.utilities.keys('static')
		const functionalKeys = designSystem.utilities.keys('functional')

		const prefixes = [...new Set(functionalKeys)].sort()
		const statics = [...new Set(staticKeys)].sort()

		console.log(`Found ${statics.length} static utilities`)
		console.log(`Found ${prefixes.length} functional prefixes`)

		const fileContent = `/**
 * GENERATED FILE - DO NOT EDIT
 * Generated by scripts/sync-tailwind-metadata.mjs
 */

export const STATIC_UTILITIES = new Set(${JSON.stringify(statics, null, '\t')});

export const UTILITY_PREFIXES = new Set(${JSON.stringify(prefixes, null, '\t')});
`

		fs.writeFileSync(OUTPUT_PATH, fileContent)
		console.log(`Generated metadata at ${OUTPUT_PATH}`)
	} catch (err) {
		console.error('Failed to extract tailwind metadata:', err)
		process.exit(1)
	}
}

run()
